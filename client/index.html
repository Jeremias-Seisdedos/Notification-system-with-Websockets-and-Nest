<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications with WebSockets</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"
        integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
        crossorigin="anonymous"></script>
</head>

<body>
    <section class="container-notifications">
        <header>
            <h1>Notifications</h1>
            <div class="status-offline">
                Disconnected
            </div>
        </header>

        <div class="user-panel">
            <input type="text" id="userId" placeholder="Your user ID">
            <button id="connectBtn">Connect</button>
            <button id="disconnectBtn">Disconnect</button>
        </div>

        <div id="notificationsList"></div>
    </section>

    <script>
        const socket = io('http://localhost:3000', { autoConnect: false });

        const $connectBtn = document.getElementById('connectBtn');
        const $userId = document.getElementById('userId');
        const $statusOffline = document.querySelector('.status-offline');
        const $disconnectBtn = document.getElementById('disconnectBtn');

        let registered = false;
        let currentUserId = null;
        let notifications = [];

        $connectBtn.addEventListener('click', () => {
            if (registered)
                return alert('You are already registered');
            const id = $userId.value.trim();
            if (!id)
                return alert('Please enter a valid user ID');
            currentUserId = id;
            socket.connect();
        });

        $disconnectBtn.addEventListener('click', () => {
            if (!registered)
                return alert('You are not registered');
            registered = false;
            socket.disconnect();
        });

        socket.on('disconnect', () => {
            console.log('Socket disconnected');
            $statusOffline.textContent = 'Disconnected';
            $statusOffline.classList.add('status-offline');
            $statusOffline.style.color = 'red';
            $statusOffline.style.fontStyle = 'normal';
        });


        socket.on('connect', () => {
            console.log('Socket connected', socket.id);
            $statusOffline.textContent = 'Connected';
            $statusOffline.classList.remove('status-offline');
            $statusOffline.style.color = 'green';
            $statusOffline.style.fontStyle = 'italic';

            socket.emit('registerUser', { userId: currentUserId })
        })

        socket.on('the user was registered', (data) => {
            console.log('Registered in the service: ', data);
            registered = true;
        })

        socket.on('userRegistered', (payload) => {
            console.log('Another registered user was registered:', payload);
        });

        socket.on('new notification', (notification) => {
            console.log('ðŸ”” New notification received:', notification);
            notifications.push(notification);
            renderNotifications();
        });

        socket.on('notificationMarkedAsRead', (notification) => {
            console.log('âœ… notification marked as read:', notification);
            const idx = notifications.findIndex(n => n.id === notification.id);
            if (idx !== -1) notifications[idx] = notification;
            renderNotifications();
        });

        function renderNotifications() {
            const $notificationsList = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                $notificationsList.innerHTML = '<p>No notifications</p>';
                return;
            }

            const ul = document.createElement('ul');
            notifications.forEach(noti => {
                const li = document.createElement('li');
                li.classList.add('notification')
                if(noti.read) li.classList.add('read');
                li.innerHTML = `
                    <strong>${noti.type}</strong>: ${noti.message} 
                    ${noti.read ? '(read)' : '(unread)'} <br>
                    <small>${new Date(noti.timestamp).toLocaleString()}</small>
                    ${!noti.read ? `<button onclick="markAsRead('${noti.id}')">Mark as read</button>` : ''}
                `;
                ul.appendChild(li);
            });
            $notificationsList.innerHTML = '';
            $notificationsList.appendChild(ul);
        }

        function markAsRead(notificationId) {
            socket.emit('markAsRead', { notificationId });
        }

        socket.on('notificationNoRegistered', (msg) => console.warn(msg));
        socket.on('notificationError', (err) => console.warn(err));
        socket.on('markAsReadError', (err) => console.warn(err));

    </script>
</body>
</html>